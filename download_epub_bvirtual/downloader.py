'''
Download de Epub

@author     Wedsley Fernando AND Brenno Paiva
@company    Desconhecido
'''

import requests
import re

#Cookie vai aqui 
cookie = {'cookie': 'CloudFront-Key-Pair-Id=APKAJKNM2WP7EGSXB4LQ; BV-WebSession=%22Nk8wXxLTykA3z1ziPN7wis5du95Gcjf0lhc7%2BaPcsn8%3D%22; CloudFront-Policy=eyJTdGF0ZW1lbnQiOiBbeyJSZXNvdXJjZSI6Imh0dHBzOi8vc3RhdGljYnYuYnZpcnR1YWwuY29tLmJyLyoiLCJDb25kaXRpb24iOnsiRGF0ZUxlc3NUaGFuIjp7IkFXUzpFcG9jaFRpbWUiOjE1OTg0MTg1MjJ9fX1dfQ__; CloudFront-Signature=dar9O2WOmzkiuWlFIehYF25fzlSu~cOkslSr0xbCE2HYnv1Y6MWYY6Du3MvfGRoS8tRF~sTSbsXVGfctorUfQeTPG5qBi3AGZGDwOrYpYdg~onTW~y1nk942bjc7-tOkt3XF5JIMKd6DMQe4mQlfI6UhD-q~QiPr8cm683KdN9cqbgPvaRI1nGfo2V02zPBGW9zDzx2alZxj8VuSQrsgRJzVO54rpXN1VMWDuSxsL4xGZyLhu24T7aSIBTsiw3vmzMlmS8wEdueuXQSw53HclyLpUKaEYRc6tFCaU6fUyN3iqcBXqhsJbedrBraATjTfi9gjHaw3qloclCYfSwrc9w__'}

#header com passgem em parametro do cookie
header = {'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) '
                        'AppleWebKit/537.36 (KHTML, like Gecko) '
                        'Chrome/51.0.2704.103 Safari/537.36'}

#apresentação do programa
print ('-------------------------------------------------')
print ('             Downloader de Epub                  ')
print ('-------------------------------------------------')


#Nome do arquivo de saida
file_name = input("Digite um nome para Saida do Livro: ")
print ('-------------------------------------------------')

num_paginas = int(input("Quantas Paginas tem o Livro?: "))
print ('-------------------------------------------------')
#inicio do processo
print ('-------------------------------------------------')
print ('                  Baixando                       ')
print ('-------------------------------------------------')


#contador da função 
cont = 0
html = ""

#while para baixar todas paginas desejadas
while cont < num_paginas:
    cont += 1

    #url para download
    url_to_download = 'https://plataforma.bvirtual.com.br/Leitor/pagination?code=WJZQp8C09UkVkWr26CKMh94Uc7hqrmbQmv9eHkiyk7agL6qH%2FTsjonK0VRkMrndayvFK1ZwRjB9%2Fvr6czrVjyw%3D%3D&page='+str(cont)+'&hash=&FormatoId=epub';

    try:
        #Tentando conexão com o servidor
        request = requests.get(url_to_download, headers=header, cookies=cookie)
    except Exception as e:
        print("Erro ",e)
        continue
 
    html += request.text
    print("Downloading "+str(request)+"....................   "+str(cont)+"/"+str(num_paginas))

#Escrevendo conteudo no arquivo
html = html.rstrip("\n")
html = html.rstrip("\t")
file = open(file_name, 'w')
file.write(str(html))
file.close()

print('-----------------------------------------------------------')
print("Conteudo Baixado")
print('-----------------------------------------------------------')
